<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>README.md - Grip</title>
  <link rel="icon" href="/__/grip/static/favicon.ico" />
  <link rel="stylesheet" href="/__/grip/asset/github-c4d5af25254cfc8bb30ae5cb6f074c97.css" />
  <link rel="stylesheet" href="/__/grip/asset/frameworks-0b6eee1f89d4460d83bdbee0a4cb0020.css" />
  <link rel="stylesheet" href="/__/grip/asset/site-83dc1f7ebc9c7461fe1eab799b56c4c4.css" />
  <link rel="stylesheet" href="/__/grip/static/octicons/octicons.css" />
  <style>
    /* Page tweaks */
    .preview-page {
      margin-top: 64px;
    }
    /* User-content tweaks */
    .timeline-comment-wrapper > .timeline-comment:after,
    .timeline-comment-wrapper > .timeline-comment:before {
      content: none;
    }
    /* User-content overrides */
    .discussion-timeline.wide {
      width: 920px;
    }
  </style>
</head>
<body>
  <div class="page">
    <div id="preview-page" class="preview-page" data-autorefresh-url="/__/grip/refresh/">

    

      <div role="main" class="main-content">

        <div class="container new-discussion-timeline experiment-repo-nav">
          <div class="repository-content">
            <div id="readme" class="readme boxed-group clearfix announce instapaper_body md">
              
              <article class="markdown-body entry-content" itemprop="text" id="grip-content">

                <h1>
<a id="user-content-rapport-ipc" class="anchor" href="#rapport-ipc" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>Rapport IPC</h1>
<p><strong>Etudiants :</strong></p>
<ul>
<li>JACOUD Bastien</li>
<li>REMOND Victor</li>
<li>TAGUEJOU Christian</li>
<li>TARDY Martial</li>
</ul>
<p><strong>Projet GIT</strong></p>
<ul>
<li>Lien <a href="https://github.com/Elomidas/POP3">dépôt GitHub</a>
</li>
<li>Téléchargement <a href="https://github.com/Elomidas/POP3/releases/tag/POP3-OK">version stable POP3</a>
</li>
</ul>
<h2>
<a id="user-content-i---introduction" class="anchor" href="#i---introduction" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>I - Introduction</h2>
<p>L'objectif de ce TP était dans un premier temps de réaliser un client et un serveur POP3 respectant la norme RFC 1939 trouvable à l'adresse <a href="https://www.ietf.org/rfc/rfc1939.txt" rel="nofollow">https://www.ietf.org/rfc/rfc1939.txt</a>.</p>
<p>Pour mener à bien ce projet, nous avons commencé par réfléchir aux schémas des automates découlant de cette norme, avant de nous lancer dans le développement des deux parties du projet en java.</p>
<p>Une fois notre couple Client - Serveur fonctionnel avec le protocole POP3, nous l'avons modifié afin qu'il utilise le protocole POP3S, en remplaçant les commandes <em>USER</em> et <em>PASS</em> par une unique commande <em>APOP</em> et l'utilisation d'un timbre à date.</p>
<h2>
<a id="user-content-ii---notice-dutilisation" class="anchor" href="#ii---notice-dutilisation" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>II - Notice d'utilisation</h2>
<p>Afin de pouvoir utiliser la messagerie correctement, l'utilisateur doit tout d'abord passer par une phase d'authentification. Lors de cette authentification, il doit notamment spécifier l'adresse IP et le port du serveur, mais aussi son adresse mail et son mot de passe.</p>
<p><a href="./images/connexion.jpg" target="_blank"><img src="./images/connexion.jpg" alt="alt text" style="max-width:100%;"></a></p>
<p>Sur la capture d'écran ci-dessus, nous observons bien que l'utilisateur doit mentionner l'adresse IP de la machine serveur(<strong>3</strong>) et le port sur lequel le programme est exécuté(<strong>4</strong>).
Il doit également inscrire son adresse mail(<strong>1</strong>) ainsi que son mot de passe(<strong>2</strong>). Lors du renseignement du mot de passe, ce dernier n'apparaît pas en clair sur la fenêtre d'affichage, visible par l'utilisateur.</p>
<p>Une fois la phase d'identification et d'authentification achevée, une nouvelle fenêtre s'affiche alors à l'écran. Il s'agit de la messagerie du client, dont voici une capture d'écran :</p>
<p><a href="./images/POP3_num.png" target="_blank"><img src="./images/POP3_num.png" alt="alt text" style="max-width:100%;"></a></p>
<p>L'adresse mail de l'utilisateur actuellement connecté(<strong>1</strong>), ainsi qu'un bouton lui permettant de se déconnecter(<strong>2</strong>) apparaissent directement sur la fenêtre du client. Il est important de noter qu'il existe deux moyens pour l'utilisateur de se déconnecter : il peut cliquer sur le bouton déconnexion ou alors directement fermer la fenêtre via un clic sur la croix rouge. Dans chacun de ces cas, le client envoie la commande "QUIT" au serveur, qui va se charger de la suppression des messages marqués.</p>
<p>Une liste, avec pagination automatique, de tous les mails réceptionnés(<strong>3</strong>) est dsponible sur la partie gauche de la fenêtre. Chaque numéro de mail(<strong>8</strong>) correspond à un lien et permet d'afficher directement via un clic sur ce dernier son contenu dans la partie droite de la fenetre(<strong>7</strong>).</p>
<p>Le bouton Actualiser(<strong>4</strong>) permet de réafficher tous les messages réceptionnés, y compris les messages venant tout juste d'être reçus.
Le bouton Répondre(<strong>5</strong>) nous rediriger automatiquement vers l'onglet Envoi de mail et pré-rempli tous les champs nécessaires à la réponse.
Le bouton Supprimer(<strong>6</strong>) nous permet de supprimer un mail. Ce dernier apparaît alors en rouge tant que l'utilisateur reste connecté et sera supprimé à la déconnexion du client.</p>
<p>Il est important de noter que la partie envoi de message n'est pas présentée dans ce compte rendu car son implémentation fait l'objet du prochain tp.</p>
<h2>
<a id="user-content-ii---la-partie-client" class="anchor" href="#ii---la-partie-client" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>II - La partie Client</h2>
<p>Le client POP3 avait pour but de permettre à un utilisateur de se connecter au serveur POP3 (en renseignant l'adresse de ce dernier et le port sur lequel il voulait se connecter), de relever ses mails et de pouvoir les afficher.
Il n'était pas nécessaire de permettre à celui-ci d'envoyer des nouveaux messages ou de lui laisser la possibilité de supprimer ses messages.</p>
<h3>
<a id="user-content-1---algorithme" class="anchor" href="#1---algorithme" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>1 - Algorithme</h3>
<p>Ci-dessous le code Java basique d'un main de client POP3</p>
<div class="highlight highlight-source-java"><pre><span class="pl-k">public</span> <span class="pl-k">static</span> <span class="pl-k">void</span> main(<span class="pl-k">String</span>[] args) {
	<span class="pl-c"><span class="pl-c">//</span>Création d'un objet client POP3</span>
	<span class="pl-smi">POP3</span> client <span class="pl-k">=</span> <span class="pl-k">new</span> <span class="pl-smi">POP3</span>();
	<span class="pl-k">boolean</span> connected <span class="pl-k">=</span> <span class="pl-c1">false</span>;
	<span class="pl-k">while</span>(connected <span class="pl-k">==</span> <span class="pl-c1">false</span>) {
		<span class="pl-c"><span class="pl-c">//</span>Connexion du client au serveur, via son adresse IP et le numéro de port souhaité</span>
		client<span class="pl-k">.</span>joinServer(<span class="pl-s"><span class="pl-pds">"</span>192.168.43.18<span class="pl-pds">"</span></span>, <span class="pl-c1">1210</span>);
		<span class="pl-c"><span class="pl-c">//</span>Authentification de l'utilisateur</span>
		connected <span class="pl-k">=</span> client<span class="pl-k">.</span>authenticate(<span class="pl-s"><span class="pl-pds">"</span>vremond@email.com<span class="pl-pds">"</span></span>, <span class="pl-s"><span class="pl-pds">"</span>Else<span class="pl-pds">"</span></span>);
	}
	<span class="pl-c"><span class="pl-c">//</span>Passage à la boucle principale du client POP3</span>
	client<span class="pl-k">.</span>transactions();
	<span class="pl-c"><span class="pl-c">//</span>Fermeture du client</span>
	client<span class="pl-k">.</span>close();
	<span class="pl-c"><span class="pl-c">//</span>Fin de l'execution</span>
}</pre></div>
<p>Ainsi que le code Java basique de la gestion des transactions par le client</p>
<div class="highlight highlight-source-java"><pre><span class="pl-k">class</span> <span class="pl-en">POP3</span> {
	<span class="pl-k">public</span> <span class="pl-en">POP3</span>() {
		<span class="pl-c"><span class="pl-c">/*</span>  Initialisation du client</span>
<span class="pl-c">		 <span class="pl-c">*/</span></span>
	}

	<span class="pl-k">protected</span> <span class="pl-smi">String</span> <span class="pl-en">getFromUser</span>() {
		<span class="pl-c"><span class="pl-c">/*</span>  Récupère la commande à executer via l'interface utilisateur</span>
<span class="pl-c">		 *  Varie selon l'interface homme-machine utilisée.</span>
<span class="pl-c">		 <span class="pl-c">*/</span></span>
		<span class="pl-k">return</span> command;
	}

	<span class="pl-c"><span class="pl-c">/*</span> Autres fonctions <span class="pl-c">*/</span></span>

	<span class="pl-k">public</span> <span class="pl-en">transactions</span>() {
		<span class="pl-smi">String</span> command;
		<span class="pl-k">boolean</span> quit <span class="pl-k">=</span> <span class="pl-c1">false</span>;
		<span class="pl-k">while</span>(quit <span class="pl-k">==</span> <span class="pl-c1">false</span>) {
			command <span class="pl-k">=</span> <span class="pl-c1">this</span><span class="pl-k">.</span>getFromUser();
			<span class="pl-c"><span class="pl-c">//</span>Récupération de chaque mot de la commande individuellement</span>
			<span class="pl-k">String</span>[] splitCommand <span class="pl-k">=</span> command<span class="pl-k">.</span>split(<span class="pl-s"><span class="pl-pds">"</span> <span class="pl-pds">"</span></span>);
			<span class="pl-c"><span class="pl-c">//</span>Analyse du premier mot, forcé en minuscule pour ignorer la casse</span>
			<span class="pl-k">switch</span>(splitCommand[<span class="pl-c1">0</span>]) {
				<span class="pl-k">case</span> <span class="pl-s"><span class="pl-pds">"</span>quit<span class="pl-pds">"</span></span><span class="pl-k">:</span>
					<span class="pl-c1">this</span><span class="pl-k">.</span>quit();
					quit <span class="pl-k">=</span> <span class="pl-c1">true</span>;
					<span class="pl-k">break</span>;
				<span class="pl-k">case</span> <span class="pl-s"><span class="pl-pds">"</span>stat<span class="pl-pds">"</span></span><span class="pl-k">:</span>
					<span class="pl-c1">this</span><span class="pl-k">.</span>stat();
					<span class="pl-k">break</span>;
				<span class="pl-k">case</span> <span class="pl-s"><span class="pl-pds">"</span>list<span class="pl-pds">"</span></span><span class="pl-k">:</span>
					<span class="pl-c1">this</span><span class="pl-k">.</span>list();
					<span class="pl-k">break</span>;
				<span class="pl-k">case</span> <span class="pl-s"><span class="pl-pds">"</span>dele<span class="pl-pds">"</span></span><span class="pl-k">:</span>
					<span class="pl-c"><span class="pl-c">/*</span> On n'execute la commande que si un argument a été passé en </span>
<span class="pl-c">					 * paramètre en entrée.</span>
<span class="pl-c">					 <span class="pl-c">*/</span></span>
					<span class="pl-c"><span class="pl-c">/*</span> La validité de cet argument sera quant à elle vérifiée dans </span>
<span class="pl-c">					 * la fonction.</span>
<span class="pl-c">					 <span class="pl-c">*/</span></span>
					<span class="pl-k">if</span>(splitCommand<span class="pl-k">.</span>length <span class="pl-k">&gt;</span> <span class="pl-c1">1</span>) {
						<span class="pl-c1">this</span><span class="pl-k">.</span>dele(splitCommand[<span class="pl-c1">1</span>]);
					}
					<span class="pl-k">break</span>;
				<span class="pl-k">case</span> <span class="pl-s"><span class="pl-pds">"</span>retr<span class="pl-pds">"</span></span><span class="pl-k">:</span>
					<span class="pl-c"><span class="pl-c">/*</span> On n'execute la commande que si un argument a été passé en </span>
<span class="pl-c">					 * paramètre en entrée.</span>
<span class="pl-c">					 <span class="pl-c">*/</span></span>
					<span class="pl-c"><span class="pl-c">/*</span> La validité de cet argument sera quant à elle vérifiée dans </span>
<span class="pl-c">					 * la fonction.</span>
<span class="pl-c">					 <span class="pl-c">*/</span></span>
					<span class="pl-k">if</span>(splitCommand<span class="pl-k">.</span>length <span class="pl-k">&gt;</span> <span class="pl-c1">1</span>) {
						<span class="pl-c1">this</span><span class="pl-k">.</span>retr(splitCommand[<span class="pl-c1">1</span>]);
					}
					<span class="pl-k">break</span>;
				<span class="pl-k">case</span> <span class="pl-s"><span class="pl-pds">"</span>noop<span class="pl-pds">"</span></span><span class="pl-k">:</span>
					<span class="pl-c1">this</span><span class="pl-k">.</span>noop();
					<span class="pl-k">break</span>;
				<span class="pl-k">case</span> <span class="pl-s"><span class="pl-pds">"</span>rset<span class="pl-pds">"</span></span> <span class="pl-k">:</span>
					<span class="pl-c1">this</span><span class="pl-k">.</span>rset();
					<span class="pl-k">break</span>;
				<span class="pl-k">default</span><span class="pl-k">:</span>
					<span class="pl-k">break</span>;
			}
		}
	}
}</pre></div>
<p>On notera que dans la fonction ci-dessus, les codes d'actualisation des informations visibles par l'utilisateur ne sont pas détaillés étant données qu'ils sont totalement différents selon le style d'affichage utilisé
(invité de commandes ou interface graphique). De plus ils n'apporteraient pas forcement d'informations utiles pour comprendre le fonctionnement du protocole.</p>
<h3>
<a id="user-content-2---développement" class="anchor" href="#2---d%C3%A9veloppement" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>2 - Développement</h3>
<p>Dans la phase de développement, nous avons fait le choix de créer une classe gérant le protocole TCP afin d'effectuer la connexion avec le serveur. Cette <a href="https://github.com/Elomidas/POP3/blob/master/Client/src/Model/Protocols/TCP/TCP.java">classe TCP</a> est elle même utilisée par notre <a href="https://github.com/Elomidas/POP3/blob/master/Client/src/Model/Protocols/POP3/POP3.java">classe POP3</a>, ainsi
lorsque la fonction de connexion de POP3 est appelée, la classe fait elle même appel à TCP.</p>
<p>De même, pour l'envoi de commande, le client POP3 utilise la fonction <em>send</em> définie dans la <a href="https://github.com/Elomidas/POP3/blob/master/Client/src/Model/Protocols/TCP/TCP.java">classe TCP</a> et la fonction <em>receive</em> pour récupérer les réponses envoyées par le serveur.</p>
<p>D'autres fonctions définies dans la <a href="https://github.com/Elomidas/POP3/blob/master/Client/src/Model/Protocols/POP3/POP3.java">classe POP3</a> permettent d'envoyer une commande au serveur et d'attendre la réponse, voire même de tester si celle-ci est positive avant de la retourner.</p>
<p>Pour effectuer divers vérifications, nous avons créé un <a href="https://github.com/Elomidas/POP3/tree/master/Client/src/Utilities">package utilities</a> contenant une classe définissant diverses méthodes statiques permettant de faire des tests via des expressions régulères, telles que vérifier
qu'une réponse du serveur commance bien par <em>+OK</em> ou encore découper la chaine de caractères qui représente le mail afin de ne récupérer que les informations qui nous intéressent (<em>expéditeur</em>, <em>objet</em>, <em>message</em>, etc...).</p>
<p>En ce qui concerne la transition du client de <a href="https://github.com/Elomidas/POP3/blob/master/Client/src/Model/Protocols/POP3/POP3.java">POP3</a> vers POP3S, elle a été extrêmement facile à opérer. En effet nous avons juste eu à créer une <a href="https://github.com/Elomidas/POP3/blob/master/Client/src/Model/Protocols/POP3/POP3S.java">classe POP3S</a> héritant de la <a href="https://github.com/Elomidas/POP3/blob/master/Client/src/Model/Protocols/POP3/POP3.java">classe POP3</a> et redifinissant la fonction
d'authentification. Ainsi nous avons eu un client POP3S fonctionnel en récupérant la quasi totalité du code déjà mis en place précédemment, les seules modifications à apporter étant la récupération d'un timbre à date
(extrait de la réponse du serveur grâce à une des fonctions du package utilities évoqué ci-dessus) et l'envoi d'une commande <em>APOP</em>, encryptée en MD5 grâce au timbre à date récupéré pécédemment, à la place des commandes
<em>USER</em> et <em>PASS</em> utilisées par le protocole POP3 classique.</p>
<p>De plus les classes TCP, POP3 et POP3S ont été codées de sorte à emettre des exceptions avec un message d'explication en cas d'erreur et à propager ces dernières jusqu'à ce qu'elles puissent être affichées. A chaque
propagation, un message supplémentaire est ajouté à l'exception si cela est jugé nécessaire.</p>
<h3>
<a id="user-content-3---partie-graphique" class="anchor" href="#3---partie-graphique" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>3 - Partie Graphique</h3>
<p>L'interface graphique du client à été réalisé grâce à la bibliothèque graphique JavaFX. Les différents composants de chacune des fenêtres ont été créés grâce à SceneBuilder et sont stockées dans les fichiers FXML correspondants.</p>
<p>Les vérifications sont effectuées à la fois côté client et côté serveur, dans la mesure du possible. Par exemple, l'utilisateur ne peut accéder au bouton de connexion que si les différents champs ont été correctement remplis. Pour cela, nous utilisons différentes Regex pour vérifier si une adresse mail ou une adresse IP est correcte. Il s'agit des vérifications effectuées côté client. De l'autre côté nous traitons les réponses renvoyés par le serveur pour faire remonter les erreurs sous forme d'exceptions. Lorsqu'une exception est levée, une alertbox est affichée à l'écran de l'utilisateur pour lui indiquer l'erreur qui a eu lieu.
D'autres alertbox peuvent également suivenir pour demander confirmartion à l'utilisateur, par exemple lors de la suppression d'un message.</p>
<p>Tout ceci va donc rendre plus agréable l'utilisation du logiciel par l'utilisateur.</p>
<h2>
<a id="user-content-iii---la-partie-serveur" class="anchor" href="#iii---la-partie-serveur" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>III - La partie Serveur</h2>
<p>La partie Serveur a été faite en deux étapes. Dans un premier temps, nous avons géré la connexion
de l'utilisateur par le protocole TCP, puis la communication entre le client et le serveur grâce aux
commandes POP3.</p>
<h3>
<a id="user-content-1---connexion-tcp" class="anchor" href="#1---connexion-tcp" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>1 - Connexion TCP</h3>
<p>Avant qu'un utilisateur n'essaye de se connecter, on lance le serveur sur un port choisi. Pour
cela, on instancie la classe SocketServer. Cet objet prendra en charge la transimission des données.
Nous avons défini une boucle sans fin pour que le serveur puisse accepter toutes les connexions
tant que celles-ci se font sur le bon port.</p>
<div class="highlight highlight-source-java"><pre>        <span class="pl-k">try</span>{
            <span class="pl-smi">ServerSocket</span> serverSocket <span class="pl-k">=</span> <span class="pl-k">new</span> <span class="pl-smi">ServerSocket</span>(port);
            <span class="pl-smi">System</span><span class="pl-k">.</span>out<span class="pl-k">.</span>println(<span class="pl-s"><span class="pl-pds">"</span>Lancement du serveur sur le port <span class="pl-pds">"</span></span> <span class="pl-k">+</span> port);
            <span class="pl-k">while</span> (<span class="pl-c1">true</span>){
                <span class="pl-smi">Socket</span> socketClient <span class="pl-k">=</span> serverSocket<span class="pl-k">.</span>accept();
                <span class="pl-smi">Tcp</span> t <span class="pl-k">=</span> <span class="pl-k">new</span> <span class="pl-smi">Tcp</span>(socketClient);
                t<span class="pl-k">.</span>start();
            }
        }<span class="pl-k">catch</span>(<span class="pl-smi">Exception</span> e){
            e<span class="pl-k">.</span>printStackTrace();
        }</pre></div>
<p>Lorsqu'un client se connecte sur le bon port, la méthode accept() de la classe SocketServer va
retourner un objet Socket représentant la connexion du client. Pour pouvoir traiter plusieurs
connexion à la fois, un thread va être créé à partir de cet objet. Lorsque le thread est lancé,
la méthode run() de la classe Tcp s'éxécute. Dans cette méthode on instancie la classe ObjetConnecte
qui va par la suite communiquer avec l'utilisateur en utilisant les méthodes receive() et send().</p>
<h3>
<a id="user-content-2---pop3" class="anchor" href="#2---pop3" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>2 - POP3</h3>
<h4>
<a id="user-content-1---développement" class="anchor" href="#1---d%C3%A9veloppement" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>1 - Développement</h4>
<p>Pour la création du serveur POP3 nous avons suivi l'automate créé lors de la première séance, c'est à dire la gestion des états et des commandes en fonction de ces états.</p>
<p>Pour chaque état certaines commandes sont utilisables. On retrouve dans l'état autorisation la commande USER et QUIT, dans l'état authentification la commande PASS et QUIT, pour finir dans l'état transaction les commandes QUIT,RSET, DELE, STAT, LIST, NOOP, UIDL. Chaque commande correspond à une action sur le serveur.
Comme expliqué précédemment la classe ObjetConnecte contient une instance de la classe Tcp qui permet d'échanger les messages avec le client.</p>
<p>Lorsque la connexion tcp est effectuée la fonction <code>Launch</code> de ObjetConnecte est appelée. Elle préviendra le client que la connexion est bien effective puis attendra les commandes demandées par le client.
Lors de la réception d'une commande le Serveur rentre dans la fonction correspondante à l'état actuel du serveur stocké dans la variable m_etat. Dans chaque fonction d'état nous appelons la fonction correspondante à la commande si l'état le permet sinon nous répondons un message indiquant que la commande n'est pas valide.</p>
<h4>
<a id="user-content-2---algorithme" class="anchor" href="#2---algorithme" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>2 - Algorithme</h4>
<p>On retrouve tout d'abord la fonction principale de <code>ObjetConnecte</code> ainsi que son constructeur:</p>
<div class="highlight highlight-source-java"><pre>
<span class="pl-k">public</span> ObjetConnecte(<span class="pl-smi">Tcp</span> tcp) {
    <span class="pl-c"><span class="pl-c">//</span>Initialisation du tcp et des autres variables</span>
}

 <span class="pl-k">public</span> <span class="pl-k">void</span> Launch() {
    <span class="pl-c"><span class="pl-c">//</span>Initialisation du serveur à l'état AUTHORISATION</span>
    m_etat <span class="pl-k">=</span> <span class="pl-c1">POP3_ETAT_AUTORISATION</span>;
    <span class="pl-smi">String</span> input;

    <span class="pl-c"><span class="pl-c">//</span>reponse apres connexion tcp</span>
    <span class="pl-smi">m_tcp<span class="pl-k">.</span>Send</span>(<span class="pl-smi">ObjetConnecte</span><span class="pl-c1"><span class="pl-k">.</span>POP3_REPONSE_POSITIVE</span> <span class="pl-k">+</span> <span class="pl-s"><span class="pl-pds">"</span> POP3 server ready<span class="pl-pds">"</span></span>);

    <span class="pl-c"><span class="pl-c">//</span>boucle principale</span>
    <span class="pl-k">while</span> (m_continuer) {
        <span class="pl-k">try</span> {

            <span class="pl-c"><span class="pl-c">//</span>Attente de la reception d'un message venant d'un client</span>
            <span class="pl-smi">System</span><span class="pl-k">.</span>out<span class="pl-k">.</span>println(<span class="pl-s"><span class="pl-pds">"</span>Wait...<span class="pl-pds">"</span></span>);
            input <span class="pl-k">=</span> <span class="pl-smi">m_tcp<span class="pl-k">.</span>Receive</span>();
            <span class="pl-smi">System</span><span class="pl-k">.</span>out<span class="pl-k">.</span>println(input <span class="pl-k">+</span> <span class="pl-s"><span class="pl-pds">"</span> received<span class="pl-pds">"</span></span>);

            <span class="pl-c"><span class="pl-c">//</span>Récupération de la commande, vérifications et traitement</span>
            <span class="pl-k">String</span>[] explodedCommand <span class="pl-k">=</span> input<span class="pl-k">.</span>split(<span class="pl-s"><span class="pl-pds">"</span> <span class="pl-pds">"</span></span>, <span class="pl-c1">2</span>);
            <span class="pl-smi">String</span> command <span class="pl-k">=</span> explodedCommand[<span class="pl-c1">0</span>]<span class="pl-k">.</span>toUpperCase();
            <span class="pl-k">String</span>[] parameters <span class="pl-k">=</span> <span class="pl-k">new</span> <span class="pl-smi">String</span>[<span class="pl-c1">0</span>];
            <span class="pl-k">if</span>(explodedCommand<span class="pl-k">.</span>length <span class="pl-k">&gt;</span> <span class="pl-c1">1</span>) {
                parameters <span class="pl-k">=</span> explodedCommand[<span class="pl-c1">1</span>]<span class="pl-k">.</span>split(<span class="pl-s"><span class="pl-pds">"</span> <span class="pl-pds">"</span></span>);
            }
            <span class="pl-smi">String</span> response;
            
            <span class="pl-c"><span class="pl-c">//</span>En fonction de l'etat actuel du serveur</span>
            <span class="pl-k">switch</span> (m_etat) {
                <span class="pl-k">case</span> <span class="pl-smi">ObjetConnecte</span><span class="pl-c1"><span class="pl-k">.</span>POP3_ETAT_AUTORISATION</span><span class="pl-k">:</span>
                    response <span class="pl-k">=</span> <span class="pl-c1">this</span><span class="pl-k">.</span>AuthorisationState(command, parameters);
                    <span class="pl-k">break</span>;
                <span class="pl-k">case</span> <span class="pl-smi">ObjetConnecte</span><span class="pl-c1"><span class="pl-k">.</span>POP3_ETAT_AUTHENTIFICATION</span><span class="pl-k">:</span>
                    response <span class="pl-k">=</span> <span class="pl-c1">this</span><span class="pl-k">.</span>AuthenticationState(command, parameters);
                    <span class="pl-k">break</span>;
                <span class="pl-k">case</span> <span class="pl-smi">ObjetConnecte</span><span class="pl-c1"><span class="pl-k">.</span>POP3_ETAT_TRANSACTION</span><span class="pl-k">:</span>
                    response <span class="pl-k">=</span> <span class="pl-c1">this</span><span class="pl-k">.</span>TransactionState(command, parameters);
                    <span class="pl-k">break</span>;
                <span class="pl-k">default</span><span class="pl-k">:</span> <span class="pl-c"><span class="pl-c">//</span>etat non reconnu</span>
                    response <span class="pl-k">=</span> <span class="pl-smi">ObjetConnecte</span><span class="pl-c1"><span class="pl-k">.</span>POP3_REPONSE_NEGATIVE</span>;
                    <span class="pl-k">break</span>;
            }
            <span class="pl-c"><span class="pl-c">//</span>reponse au Client</span>
            <span class="pl-smi">System</span><span class="pl-k">.</span>out<span class="pl-k">.</span>println(<span class="pl-s"><span class="pl-pds">"</span>Response : <span class="pl-pds">"</span></span> <span class="pl-k">+</span> response);
            <span class="pl-smi">m_tcp<span class="pl-k">.</span>Send</span>(response);
        } <span class="pl-k">catch</span> (<span class="pl-smi">IOException</span> e) {
            e<span class="pl-k">.</span>printStackTrace();
        }
    }
    <span class="pl-c"><span class="pl-c">//</span> on est sorti de la boucle m_continuer on ferme le serveur</span>
    <span class="pl-smi">System</span><span class="pl-k">.</span>out<span class="pl-k">.</span>println(<span class="pl-s"><span class="pl-pds">"</span>End of POP3<span class="pl-pds">"</span></span>);
}</pre></div>
<p>Puis les fonctions de chaque état:</p>
<div class="highlight highlight-source-java"><pre><span class="pl-c"><span class="pl-c">//</span>Etat autorisation</span>
<span class="pl-k">protected</span> <span class="pl-smi">String</span> AuthorisationState(<span class="pl-smi">String</span> command, <span class="pl-k">String</span>[] parameters) {
   <span class="pl-c"><span class="pl-c">//</span>reception de la commande USER</span>
    <span class="pl-k">if</span> (command<span class="pl-k">.</span>equals(<span class="pl-s"><span class="pl-pds">"</span>USER<span class="pl-pds">"</span></span>)) {
        <span class="pl-c"><span class="pl-c">//</span>Verification que le nom d'utilisateur passé en paramètre est </span>
        <span class="pl-c"><span class="pl-c">//</span> bien dans nos données</span>
        <span class="pl-k">if</span>(parameters<span class="pl-k">.</span>length <span class="pl-k">&lt;</span> <span class="pl-c1">1</span>) {
            <span class="pl-c"><span class="pl-c">//</span>si il manque des parametres on retourne un message d'erreur</span>
            <span class="pl-k">return</span> <span class="pl-smi">ObjetConnecte</span><span class="pl-c1"><span class="pl-k">.</span>POP3_REPONSE_NEGATIVE</span> <span class="pl-k">+</span> <span class="pl-s"><span class="pl-pds">"</span> parameter missing.<span class="pl-pds">"</span></span>;
        }
        <span class="pl-k">if</span>(<span class="pl-c1">this</span><span class="pl-k">.</span>checkUser(username)) {
            <span class="pl-c"><span class="pl-c">//</span>on passe dans l'état authentification</span>
            m_etat <span class="pl-k">=</span> <span class="pl-c1">POP3_ETAT_AUTHENTIFICATION</span>;
            <span class="pl-k">return</span> <span class="pl-smi">ObjetConnecte</span><span class="pl-c1"><span class="pl-k">.</span>POP3_REPONSE_POSITIVE</span>;
        } <span class="pl-k">else</span> {
            <span class="pl-c"><span class="pl-c">//</span>si l'utilisateur n'est pas correct on retourne un message d'erreur</span>
            <span class="pl-k">return</span> <span class="pl-smi">ObjetConnecte</span><span class="pl-c1"><span class="pl-k">.</span>POP3_REPONSE_NEGATIVE</span> <span class="pl-k">+</span> <span class="pl-s"><span class="pl-pds">"</span> username is not valid<span class="pl-pds">"</span></span>;
        }
    }
    <span class="pl-c"><span class="pl-c">//</span>Sinon retourne erreur de commande</span>
    <span class="pl-k">return</span> <span class="pl-smi">ObjetConnecte</span><span class="pl-c1"><span class="pl-k">.</span>POP3_REPONSE_NEGATIVE</span> <span class="pl-k">+</span> <span class="pl-s"><span class="pl-pds">"</span> command <span class="pl-cce">\"</span><span class="pl-pds">"</span></span> 
        <span class="pl-k">+</span> command <span class="pl-k">+</span> <span class="pl-s"><span class="pl-pds">"</span><span class="pl-cce">\"</span> doesn't seem valid<span class="pl-pds">"</span></span>;
}

<span class="pl-c"><span class="pl-c">//</span>Etat authentification</span>
<span class="pl-k">protected</span> <span class="pl-smi">String</span> AuthenticationState(<span class="pl-smi">String</span> command, <span class="pl-k">String</span>[] parameters) {
   <span class="pl-c"><span class="pl-c">//</span>reception de la commande PASS</span>
    <span class="pl-k">if</span>(command<span class="pl-k">.</span>equals(<span class="pl-s"><span class="pl-pds">"</span>PASS<span class="pl-pds">"</span></span>)) {
        <span class="pl-c"><span class="pl-c">//</span>verification que le mot de passe correspond au mot de passe de l'utilisateur</span>
        <span class="pl-c"><span class="pl-c">//</span> qui vient d'etre rentré</span>
        <span class="pl-k">if</span>(parameters<span class="pl-k">.</span>length <span class="pl-k">&lt;</span> <span class="pl-c1">1</span>) {
            <span class="pl-c"><span class="pl-c">//</span> si il manque des paramètres on retourne un message d'erreur</span>
            <span class="pl-k">return</span> <span class="pl-smi">ObjetConnecte</span><span class="pl-c1"><span class="pl-k">.</span>POP3_REPONSE_NEGATIVE</span> <span class="pl-k">+</span> <span class="pl-s"><span class="pl-pds">"</span> parameter missing.<span class="pl-pds">"</span></span>;
        }

        <span class="pl-k">if</span>(<span class="pl-c1">this</span><span class="pl-k">.</span>checkPass(password)) {
                <span class="pl-c"><span class="pl-c">//</span>on recupere les emails de l'utilisateur</span>
                <span class="pl-c"><span class="pl-c">//</span>on passe dans l'etat transaction</span>
                m_etat <span class="pl-k">=</span> <span class="pl-c1">POP3_ETAT_TRANSACTION</span>;
                <span class="pl-c"><span class="pl-c">//</span>retour message positif</span>
                <span class="pl-k">return</span> <span class="pl-smi">ObjetConnecte</span><span class="pl-c1"><span class="pl-k">.</span>POP3_REPONSE_POSITIVE</span>;
        }
    } <span class="pl-k">else</span> <span class="pl-k">if</span>(command<span class="pl-k">.</span>equals(<span class="pl-s"><span class="pl-pds">"</span>QUIT<span class="pl-pds">"</span></span>)) {
        <span class="pl-k">return</span> <span class="pl-c1">this</span><span class="pl-k">.</span>quit();
    }
    <span class="pl-c"><span class="pl-c">//</span>sinon commande non valide</span>
    <span class="pl-k">return</span> <span class="pl-smi">ObjetConnecte</span><span class="pl-c1"><span class="pl-k">.</span>POP3_REPONSE_NEGATIVE</span> <span class="pl-k">+</span> <span class="pl-s"><span class="pl-pds">"</span> command <span class="pl-cce">\"</span><span class="pl-pds">"</span></span> 
        <span class="pl-k">+</span> command <span class="pl-k">+</span> <span class="pl-s"><span class="pl-pds">"</span><span class="pl-cce">\"</span> doesn't seem valid<span class="pl-pds">"</span></span>;
}

<span class="pl-c"><span class="pl-c">//</span>etat transaction</span>
<span class="pl-k">protected</span> <span class="pl-smi">String</span> TransactionState(<span class="pl-smi">String</span> command, <span class="pl-k">String</span>[] parameters) {
   <span class="pl-c"><span class="pl-c">//</span>reception des differentes commandes POP3 et appel des fonctions correspondantes</span>
    <span class="pl-k">if</span>(command<span class="pl-k">.</span>equals(<span class="pl-s"><span class="pl-pds">"</span>QUIT<span class="pl-pds">"</span></span>)) {
        <span class="pl-c1">this</span><span class="pl-k">.</span>quitTransaction();
        <span class="pl-k">return</span> <span class="pl-c1">this</span><span class="pl-k">.</span>quit();
    } <span class="pl-k">else</span> <span class="pl-k">if</span>(command<span class="pl-k">.</span>equals(<span class="pl-s"><span class="pl-pds">"</span>RETR<span class="pl-pds">"</span></span>)) {
        <span class="pl-k">if</span>(parameters<span class="pl-k">.</span>length <span class="pl-k">&lt;</span> <span class="pl-c1">1</span>) {
            <span class="pl-k">return</span> <span class="pl-smi">ObjetConnecte</span><span class="pl-c1"><span class="pl-k">.</span>POP3_REPONSE_NEGATIVE</span> <span class="pl-k">+</span> <span class="pl-s"><span class="pl-pds">"</span> parameter missing.<span class="pl-pds">"</span></span>;
        }
        <span class="pl-k">return</span> retr(parameters[<span class="pl-c1">0</span>]);
    } <span class="pl-k">else</span> <span class="pl-k">if</span>(command<span class="pl-k">.</span>equals(<span class="pl-s"><span class="pl-pds">"</span>NOOP<span class="pl-pds">"</span></span>)) {
        <span class="pl-k">return</span> noop();
    } <span class="pl-k">else</span> <span class="pl-k">if</span>(command<span class="pl-k">.</span>equals(<span class="pl-s"><span class="pl-pds">"</span>RSET<span class="pl-pds">"</span></span>)) {
        <span class="pl-k">return</span> rset();
    } <span class="pl-k">else</span> <span class="pl-k">if</span>(command<span class="pl-k">.</span>equals(<span class="pl-s"><span class="pl-pds">"</span>DELE<span class="pl-pds">"</span></span>)) {
        <span class="pl-k">if</span>(parameters<span class="pl-k">.</span>length <span class="pl-k">&lt;</span> <span class="pl-c1">1</span>) {
            <span class="pl-k">return</span> <span class="pl-smi">ObjetConnecte</span><span class="pl-c1"><span class="pl-k">.</span>POP3_REPONSE_NEGATIVE</span> <span class="pl-k">+</span> <span class="pl-s"><span class="pl-pds">"</span> parameter missing.<span class="pl-pds">"</span></span>;
        }
        <span class="pl-k">return</span> dele(<span class="pl-smi">Integer</span><span class="pl-k">.</span>parseInt(parameters[<span class="pl-c1">0</span>]));
    } <span class="pl-k">else</span> <span class="pl-k">if</span>(command<span class="pl-k">.</span>equals(<span class="pl-s"><span class="pl-pds">"</span>LIST<span class="pl-pds">"</span></span>)) {
        <span class="pl-k">return</span> list();
    } <span class="pl-k">else</span> <span class="pl-k">if</span>(command<span class="pl-k">.</span>equals(<span class="pl-s"><span class="pl-pds">"</span>UIDL<span class="pl-pds">"</span></span>)) {
        <span class="pl-k">return</span> uidl();
    } <span class="pl-k">else</span> <span class="pl-k">if</span>(command<span class="pl-k">.</span>equals(<span class="pl-s"><span class="pl-pds">"</span>STAT<span class="pl-pds">"</span></span>)) {
        <span class="pl-k">return</span> stat();
    } <span class="pl-k">else</span> {
        <span class="pl-c"><span class="pl-c">//</span>sinon commande non valide</span>
        <span class="pl-k">return</span> <span class="pl-smi">ObjetConnecte</span><span class="pl-c1"><span class="pl-k">.</span>POP3_REPONSE_NEGATIVE</span> <span class="pl-k">+</span> <span class="pl-s"><span class="pl-pds">"</span> unknown command '<span class="pl-pds">"</span></span> 
            <span class="pl-k">+</span> command <span class="pl-k">+</span> <span class="pl-s"><span class="pl-pds">"</span>'.<span class="pl-pds">"</span></span>;
    }
}</pre></div>
<h4>
<a id="user-content-3---développement-et-algorithme-pop3s" class="anchor" href="#3---d%C3%A9veloppement-et-algorithme-pop3s" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>3 - Développement et algorithme POP3S</h4>
<p>POP3S est définit par la classe ObjetConnecteSecurise et est une classse qui va hériter de ObjetConnecte.</p>
<p>On retrouve donc les mêmes attributs et quelques changements de fonctions. En effet nous avons enlevé l'etat authentification
et remplacé les commandes PASS et USER par APOP. Pour protéger l'authentification de l'utilisateur, le serveur va implémenter
la commande APOP qui mettra un timbre-à-date dans son message de bienvenue. La syntaxe de ce timbre-à-date est la suivante:
&lt;identificateur-de-processus.heure@nom-de-l’hôte&gt;.</p>
<p>La méthode generateTimbre() se charge de générer ce timbre-à-date et l'envoie à l'utilisateur. L'utilisateur va encrypter cette chaine de caractère en appliquant
l'algorithme MD5 sur le timbre-à-date, suivi du "secret partagé". Le secret partagé est une chaine de caractère connu uniquement
par le serveur et le client; dans notre le cas, le secret partagé sera le mot de passe du client.
APOP prend en paramètre le nom d'utilisateur ainsi que le mot de passe encrypté. Cette somme de contrôle sera
renvoyé au serveur.</p>
<p>Le serveur va de son coté de générer une somme de controle à partir du timbre-à-date précemment envoyé à l'utilisateur
et du mot de passe de l'utilisateur stocké dans la base de donnée. Il va ensuite comparer sa somme de contrôle à celle
renvoyé par l'utilisateur. Si les deux chaines de caractères sont égales, alors l'utilisateur pourra passer à l'état suivant.</p>
<p>Par exemple on envoit le timbre date lorsque la connextion est effectuée avec le client.</p>
<div class="highlight highlight-source-java"><pre><span class="pl-k">try</span> {
    <span class="pl-c1">this</span><span class="pl-k">.</span><span class="pl-smi">m_tcp<span class="pl-k">.</span>Send</span>(<span class="pl-smi">ObjetConnecte</span><span class="pl-c1"><span class="pl-k">.</span>POP3_REPONSE_POSITIVE</span> <span class="pl-k">+</span> <span class="pl-s"><span class="pl-pds">"</span> POP3 server ready <span class="pl-pds">"</span></span>  <span class="pl-k">+</span> generateTimbre());
} <span class="pl-k">catch</span> (<span class="pl-smi">Exception</span> e) {
    e<span class="pl-k">.</span>printStackTrace();
}</pre></div>
<p>Pour cela nous avons créé des fonctions pour former ce timbre date:</p>
<div class="highlight highlight-source-java"><pre><span class="pl-c"><span class="pl-c">//</span>Etat autorisation</span>
<span class="pl-k">protected</span> <span class="pl-smi">String</span> AuthorisationState(<span class="pl-smi">String</span> command, <span class="pl-k">String</span>[] parameters) {
    <span class="pl-c"><span class="pl-c">//</span>on recupere la commande APOP</span>
    <span class="pl-k">if</span> (command<span class="pl-k">.</span>equals(<span class="pl-s"><span class="pl-pds">"</span>APOP<span class="pl-pds">"</span></span>)) {
        <span class="pl-c"><span class="pl-c">/*</span> Si il n'y a pas deux parametres ( nom d'utilisateur et mot de passe encrypté) on </span>
<span class="pl-c">         * retourne une erreur.</span>
<span class="pl-c">         <span class="pl-c">*/</span></span>
        <span class="pl-k">if</span>(parameters<span class="pl-k">.</span>length <span class="pl-k">&lt;=</span> <span class="pl-c1">1</span>) {
            <span class="pl-k">return</span> <span class="pl-smi">ObjetConnecte</span><span class="pl-c1"><span class="pl-k">.</span>POP3_REPONSE_NEGATIVE</span> <span class="pl-k">+</span> <span class="pl-s"><span class="pl-pds">"</span> parameter missing.<span class="pl-pds">"</span></span>;
        }
        <span class="pl-smi">String</span> username <span class="pl-k">=</span> parameters[<span class="pl-c1">0</span>];
        <span class="pl-smi">String</span> password <span class="pl-k">=</span> parameters[<span class="pl-c1">1</span>];
        out<span class="pl-k">.</span>println(<span class="pl-s"><span class="pl-pds">"</span>username : <span class="pl-pds">"</span></span> <span class="pl-k">+</span> username);

    <span class="pl-c"><span class="pl-c">//</span>on verifie si l'utilisateur existe </span>
        <span class="pl-k">if</span>(<span class="pl-c1">this</span><span class="pl-k">.</span>checkUser(username)) {
            <span class="pl-k">try</span> {
                <span class="pl-c"><span class="pl-c">//</span>on verifie si le mot de passe existe</span>
                <span class="pl-k">if</span>(<span class="pl-c1">this</span><span class="pl-k">.</span>decrypteTimbre(password)) {
                    <span class="pl-c"><span class="pl-c">//</span>on recupere les emails de l'utilisateur</span>
                    <span class="pl-c"><span class="pl-c">//</span>on passe à l'etat transaction</span>
                    m_etat <span class="pl-k">=</span> <span class="pl-c1">POP3_ETAT_TRANSACTION</span>;
                    <span class="pl-k">return</span> <span class="pl-smi">ObjetConnecte</span><span class="pl-c1"><span class="pl-k">.</span>POP3_REPONSE_POSITIVE</span>;
                } <span class="pl-k">else</span> {
                    <span class="pl-k">return</span> <span class="pl-smi">ObjetConnecte</span><span class="pl-c1"><span class="pl-k">.</span>POP3_REPONSE_NEGATIVE</span> <span class="pl-k">+</span> <span class="pl-s"><span class="pl-pds">"</span> password is not valid<span class="pl-pds">"</span></span>;
                }
            } <span class="pl-k">catch</span> (<span class="pl-smi">NoSuchAlgorithmException</span> e) {
                e<span class="pl-k">.</span>printStackTrace();
            }
        } <span class="pl-k">else</span> {
            <span class="pl-k">return</span> <span class="pl-smi">ObjetConnecte</span><span class="pl-c1"><span class="pl-k">.</span>POP3_REPONSE_NEGATIVE</span> <span class="pl-k">+</span> <span class="pl-s"><span class="pl-pds">"</span> username is not valid<span class="pl-pds">"</span></span>;
        }
    }
    <span class="pl-c"><span class="pl-c">//</span>Sinon on retourne que la commande n'est pas valide</span>
    <span class="pl-k">return</span> <span class="pl-smi">ObjetConnecte</span><span class="pl-c1"><span class="pl-k">.</span>POP3_REPONSE_NEGATIVE</span> <span class="pl-k">+</span> <span class="pl-s"><span class="pl-pds">"</span> command <span class="pl-cce">\"</span><span class="pl-pds">"</span></span> <span class="pl-k">+</span> command <span class="pl-k">+</span> <span class="pl-s"><span class="pl-pds">"</span><span class="pl-cce">\"</span> doesn't seem valid<span class="pl-pds">"</span></span>;
}</pre></div>

              </article>
            </div>
          </div>
        </div>
      </div>

    

  </div>
  <div>&nbsp;</div>
  </div><script>
    function showCanonicalImages() {
      var images = document.getElementsByTagName('img');
      if (!images) {
        return;
      }
      for (var index = 0; index < images.length; index++) {
        var image = images[index];
        if (image.getAttribute('data-canonical-src') && image.src !== image.getAttribute('data-canonical-src')) {
          image.src = image.getAttribute('data-canonical-src');
        }
      }
    }

    function scrollToHash() {
      if (location.hash && !document.querySelector(':target')) {
        var element = document.getElementById('user-content-' + location.hash.slice(1));
        if (element) {
           element.scrollIntoView();
        }
      }
    }

    function autorefreshContent(eventSourceUrl) {
      var initialTitle = document.title;
      var contentElement = document.getElementById('grip-content');
      var source = new EventSource(eventSourceUrl);
      var isRendering = false;

      source.onmessage = function(ev) {
        var msg = JSON.parse(ev.data);
        if (msg.updating) {
          isRendering = true;
          document.title = '(Rendering) ' + document.title;
        } else {
          isRendering = false;
          document.title = initialTitle;
          contentElement.innerHTML = msg.content;
          showCanonicalImages();
        }
      }

      source.onerror = function(e) {
        if (e.readyState === EventSource.CLOSED && isRendering) {
          isRendering = false;
          document.title = initialTitle;
        }
      }
    }

    window.onhashchange = function() {
      scrollToHash();
    }

    window.onload = function() {
      scrollToHash();
    }

    showCanonicalImages();

    var autorefreshUrl = document.getElementById('preview-page').getAttribute('data-autorefresh-url');
    if (autorefreshUrl) {
      autorefreshContent(autorefreshUrl);
    }
  </script>
</body>
</html>
